{% from "macros.html.jinja" import stat_card%}

{# -- Summary statistics - Full width -- Side-specific view (L/R/M) -- #}
<section id="summary-stats">
    <div class="row">
        <div class="col-xs-12 col-sm-6 col-md-4">
            <div class="stat-card">
                <div class="stat-number">{{ complete_summary.total_count }}</div>
                <div class="stat-label">Neurons</div>
                {% if complete_summary.left_count > 0 or complete_summary.right_count > 0 %}
                <div style="font-size: 0.8em; margin-top: 5px; color: #666;">
                     Right: {{ complete_summary.right_count }} | Left: {{ complete_summary.left_count }}
                    <br><span title="log Ratio, negative numbers lean right, positive left">
                        log ratio
                    </span>: {{ "%.2f"|format(log_ratio(complete_summary.left_count, complete_summary.right_count)) }}
                </div>
                {% endif %}
            </div>
        </div>

        <div class="col-xs-12 col-sm-6 col-md-4">
            <div class="stat-card">
                {#-- R/M/L pages: Show side-specific synapse totals with Post/Pre breakdown -- #}
                {% set total_synapses = summary.total_post_synapses + summary.total_pre_synapses %}
                <div class="stat-number">{{ total_synapses | format_synapse_count | safe }}</div>
                <div class="stat-label" title="Sum of PSDs and T-bars">Synapses</div>
                {% if summary.total_post_synapses > 0 or summary.total_pre_synapses > 0 %}
                <div style="font-size: 0.8em; margin-top: 5px; color:#666;">
                    Post: {{ summary.total_post_synapses | format_synapse_count | safe }} | Pre: {{ summary.total_pre_synapses | format_synapse_count | safe}}
                    <br><span title="Log Ratio negative numbers mean more input (post-synapses), positive numbers more output (pre-synapses)">
                    log ratio
                </span>: {{ "%.2f"|format(log_ratio(summary.total_pre_synapses, summary.total_post_synapses)) }}
                </div>
                {% endif %}
            </div>
        </div>

        <div class="col-xs-12 col-sm-6 col-md-4">
            <div class="stat-card">
                {#-- R/M/L pages: Show side-specific synapse totals with Post/Pre breakdown -- #}
                {% set total_connections = connectivity.total_upstream + connectivity.total_downstream %}
                <div class="stat-number">{{ total_connections | format_synapse_count | safe }}</div>
                <div class="stat-label">Connections</div>
                {% set upstream_connections = connectivity.total_upstream %}
                {% set downstream_connections = connectivity.total_downstream %}
                <div style="font-size: 0.8em; margin-top: 5px; color:#666;">
                    Upstream: {{ upstream_connections | format_synapse_count | safe }} | Downstream: {{ downstream_connections | format_synapse_count | safe }}
                    <br><span title="Log Ratio negative numbers mean more upstream connections, positive numbers more downstream connections">
                        log ratio
                    </span>: {{ "%.2f"|format(log_ratio(downstream_connections, upstream_connections)) }}
                </div>
            </div>
        </div>

        <div class="col-xs-12 col-sm-6 col-md-4">
            <div class="stat-card">
                {# -- R/M/L pages: Show side-specific neurotransmitters -- #}
                {% if summary.nt_analysis and summary.nt_analysis | length > 0 %}
                    {% set most_common_nt = summary.nt_analysis[0] %}
                    <div class="stat-number">{{ most_common_nt.nt_type | abbreviate_neurotransmitter | safe }}
                        {%- if most_common_nt.mean_confidence %}
                            <abbr style="font-size:14px; color:#666;" title="{{ (most_common_nt.mean_confidence*100) | format_percentage }} Confidence"> ({{ (most_common_nt.mean_confidence * 100) | format_percentage }} CL)</abbr>
                        {%- endif -%}
                    </div>
                    <div class="stat-label">Neurotransmitter</div>
                    {% if summary.nt_analysis | length > 1 %}
                        {# Show other neurotransmitters #}
                        <div style="font-size: 0.8em; margin-top: 8px; color:#666;">
                            {% for nt_info in summary.nt_analysis[1:] %}
                                <div style="margin-bottom: 2px;">
                                    {{- nt_info.nt_type | abbreviate_neurotransmitter | safe -}}
                                    : {{ nt_info.count }} neuron{{ 's' if nt_info.count > 1 -}}
                                        {%- if nt_info.mean_confidence %} (
                                            {{- (nt_info.mean_confidence*100) | format_percentage }} CL)
                                        {%- endif -%}
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% else %}
                    {# Fallback to old behavior if no nt_analysis #}
                    <div class="stat-number">{{ summary.consensus_nt | abbreviate_neurotransmitter | safe}}</div>
                    <div class="stat-label">Neurotransmitter</div>
                    {% if summary.consensus_nt != summary.celltype_predicted_nt %}
                    <div>Predicted: {{ summary.celltype_predicted_nt | abbreviate_neurotransmitter | safe}}</div>
                    {% endif %}
                    {% if summary.celltype_predicted_nt_confidence %}
                    <div style="font-size: 0.8em; margin-top:5px; color:#666;">
                        {% if summary.celltype_total_nt_predictions %}
                            Predictions: {{ summary.celltype_total_nt_predictions | format_number }}
                        {% endif %}
                        <span title="Confidence for neurotransmitter prediction">Confidence: {{ (summary.celltype_predicted_nt_confidence*100) | format_percentage}}</span>
                    </div>
                    {% elif summary.celltype_total_nt_predictions %}
                    <div style="font-size: 0.8em; margin-top:5px; color:#666;">
                        Predictions: {{ summary.celltype_total_nt_predictions | format_number }}
                    </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <div class="col-xs-12 col-sm-6 col-md-4">
            <div class="stat-card">
                {# -- R/M/L pages: Show side-specific average synapses per neuron -- #}
                {% if soma_side == 'left' %}
                    {% set side_neuron_count = complete_summary.left_count if complete_summary.left_count is defined else complete_summary.get('left_count', 0) %}
                    {% set side_pre_synapses = complete_summary.left_pre_synapses if complete_summary.left_pre_synapses is defined else complete_summary.get('left_pre_synapses', 0) %}
                    {% set side_post_synapses = complete_summary.left_post_synapses if complete_summary.left_post_synapses is defined else complete_summary.get('left_post_synapses', 0) %}
                {% elif soma_side == 'right' %}
                    {% set side_neuron_count = complete_summary.right_count if complete_summary.right_count is defined else complete_summary.get('right_count', 0) %}
                    {% set side_pre_synapses = complete_summary.right_pre_synapses if complete_summary.right_pre_synapses is defined else complete_summary.get('right_pre_synapses', 0) %}
                    {% set side_post_synapses = complete_summary.right_post_synapses if complete_summary.right_post_synapses is defined else complete_summary.get('right_post_synapses', 0) %}
                {% elif soma_side == 'middle' %}
                    {% set side_neuron_count = complete_summary.middle_count if complete_summary.middle_count is defined else complete_summary.get('middle_count', 0) %}
                    {% set side_pre_synapses = complete_summary.middle_pre_synapses if complete_summary.middle_pre_synapses is defined else complete_summary.get('middle_pre_synapses', 0) %}
                    {% set side_post_synapses = complete_summary.middle_post_synapses if complete_summary.middle_post_synapses is defined else complete_summary.get('middle_post_synapses', 0) %}
                {% endif %}

                {% if side_neuron_count > 0 %}
                    {% set side_avg_pre = (side_pre_synapses / side_neuron_count) %}
                    {% set side_avg_post = (side_post_synapses / side_neuron_count) %}
                    {% set side_avg_total = side_avg_pre + side_avg_post %}
                {% else %}
                    {% set side_avg_pre = 0 %}
                    {% set side_avg_post = 0 %}
                    {% set side_avg_total = 0 %}
                {% endif %}

                <div class="stat-number">{{ side_avg_total | format_synapse_count | safe}}</div>
                <div class="stat-label">Synapses per Neuron</div>
                {% if side_avg_pre > 0 or side_avg_post > 0 %}
                <div style="font-size: 0.8em; margin-top: 5px; color:#666;">
                    Post: {{ side_avg_post | format_synapse_count | safe }} | Pre: {{ side_avg_pre | format_synapse_count | safe }}
                    {% if side_avg_pre > 0 and side_avg_post > 0 %}
                        <br>
                        <span title="Log Ratio negative numbers mean more input (post-synapses), positive numbers more output (pre-synapses)">
                            log ratio
                        </span>: {{ "%.2f"|format(log_ratio(side_avg_pre, side_avg_post)) }}
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <div class="col-xs-12 col-sm-6 col-md-4">
            <div class="stat-card">
                {# -- R/M/L pages: Show side-specific average synapses per neuron -- #}
                {% set avg_conn = connectivity.avg_connections %}
                <div class="stat-number">{{ avg_conn | format_synapse_count | safe }}</div>
                <div class="stat-label">Connections per Neuron</div>
                {% set avg_up_conn = connectivity.avg_upstream if connectivity.avg_upstream is defined else connectivity.get('avg_upstream', 0) %}
                {% set avg_down_conn = connectivity.avg_downstream if connectivity.avg_downstream is defined else connectivity.get('avg_downstream', 0) %}
                {% if avg_up_conn > 0 or avg_down_conn > 0%}
                <div style="font-size: 0.8em; margin-top: 5px; color:#666;">
                    Upstream: {{ avg_up_conn | format_synapse_count | safe }}
                    | Downstream: {{ avg_down_conn | format_synapse_count | safe }}
                    {% if avg_up_conn > 0 and avg_down_conn > 0%}
                        <br>
                        <span title="Log Ratio negative numbers mean more upstream connections, positive numbers more downstream connections">
                            log ratio
                        </span>: {{ "%.2f"|format(log_ratio(avg_down_conn, avg_up_conn)) }}
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
