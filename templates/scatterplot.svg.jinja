<svg
  width="{{ width }}"
  height="{{ height }}"
  viewBox="0 0 {{ width }} {{ height }}"
  xmlns="http://www.w3.org/2000/svg"
>
<defs>
<style>
.axis-line { stroke:#444; stroke-width:1; shape-rendering:crispEdges; }
.tick-mark { stroke:#444; stroke-width:1; shape-rendering:crispEdges; }
.tick-label { fill:#444; font-size:14px; font-family:Helvetica, Arial, sans-serif; }
.title { fill:#777; font-size:26px; font-family:Arial, sans-serif; }
.axis-label { fill:#333; font-size:18px; font-family:Helvetica, Arial, sans-serif; cursor:pointer; }
.legend-label { fill:#555; font-size:14px; font-family:Helvetica, Arial, sans-serif; }
.legend-title { fill:#555; font-size:16px; font-family:Helvetica, Arial, sans-serif; cursor:pointer; }
.guide { stroke:#bcbcbc; fill:none; }
.dot { cursor:pointer; opacity:0.9; transition:opacity 0.15s; }
.dot:hover { opacity:1; }
.tooltip-box { pointer-events:none; transition:opacity 0.2s; z-index:9999; }
.tooltip-rect { fill:rgba(0, 0, 0, 0.8); rx:3; ry:3; }
.tooltip-text { fill:white; font-family:Helvetica, Arial, 'Liberation Sans', 'Nimbus Sans', 'DejaVu Sans', sans-serif; font-size:16px; }
</style>
</defs>

<script>
//<![CDATA[

{# sT = showTooltip #}
function sT(evt) {
  const tooltip = document.getElementById("tooltip");
  const elem = evt.target;

  let text = elem.getAttribute("data-tooltip");
  if (!text) {
    const g = evt.currentTarget;
    const c = g.querySelector("circle");
    if (c) {
      const dataTitle = c.getAttribute("data-title");
      if (dataTitle) {
        try {
          text = JSON.parse(dataTitle);
        } catch (e) {
          text = dataTitle;
        }
      }
      if (c) {
        const baseR = parseFloat(c.getAttribute("data-base-r") || "4");
        c.setAttribute("r", String(baseR * 3));
        const baseSW = parseFloat(c.getAttribute("data-base-sw") || "0.5");
        c.setAttribute("stroke-width", String(baseSW * 3));
      }
    }
  } else {
    try {
      text = JSON.parse(text);
    } catch (e) {
      // text is already a string
    }
  }

  if (!text) return;

  const lines = text.split("\n");
  const textGroup = document.getElementById("tooltip-text-group");
  while (textGroup.firstChild) textGroup.removeChild(textGroup.firstChild);

  let maxWidth = 0;
  const lineHeight = 14;
  const padding = 6;

  for (let i = 0; i < lines.length; i++) {
    const s = lines[i].trim();
    if (!s) continue;
    const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
    t.setAttribute("x", padding);
    t.setAttribute("y", padding + lineHeight + (i * lineHeight));
    t.setAttribute("class", "tooltip-text");
    t.textContent = s;
    textGroup.appendChild(t);
    const approx = s.length * 7.5;
    if (approx > maxWidth) maxWidth = approx;
  }

  const rect = document.getElementById("tooltip-rect");
  const boxWidth = Math.max(maxWidth + padding * 2, 100);
  const boxHeight = lines.length * lineHeight + padding * 2;
  rect.setAttribute("width", boxWidth);
  rect.setAttribute("height", boxHeight);

  const svgRect = evt.currentTarget.ownerSVGElement.getBoundingClientRect();
  let x = evt.clientX - svgRect.left + 10;
  let y = evt.clientY - svgRect.top - boxHeight - 10;

  if (x + boxWidth > {{ width }}) x = {{ width }} - boxWidth - 5;
  if (y < 0) y = evt.clientY - svgRect.top + 10;
  if (x < 0) x = 5;

  tooltip.setAttribute("transform", "translate(" + x + "," + y + ")");
  tooltip.setAttribute("opacity", "1");
}

{# ht = hideTooltip #}
function ht(evt) {
  const tooltip = document.getElementById("tooltip");
  if (tooltip) {
    tooltip.setAttribute("opacity", "0");
  }

  const g = evt.currentTarget;
  const c = g ? g.querySelector("circle") : null;
  if (c) {
    const baseR = parseFloat(c.getAttribute("data-base-r") || "4");
    const baseSW = parseFloat(c.getAttribute("data-base-sw") || "0.5");
    c.setAttribute("r", String(baseR));
    c.setAttribute("stroke-width", String(baseSW));
  }
}

function highlightByName(name) {
  var needle = String(name || '').trim().toLowerCase();
  if (!needle) return false;

  var markers = Array.prototype.slice.call(document.querySelectorAll('g.marker'));
  for (var i = 0; i < markers.length; i++) {
    var g = markers[i];
    var c = g.querySelector('circle');
    if (!c) continue;

    var dataType = (c.getAttribute('data-type') || '').trim().toLowerCase();
    if (!dataType || dataType !== needle) continue;

    var rect = c.getBoundingClientRect();
    sT({
      currentTarget: g,
      target: c,
      clientX: rect.left + rect.width / 2,
      clientY: rect.top + rect.height / 2
    });
    return true;
  }
  return false;
}

function getHighlightParam() {
  var hash = location.hash ? location.hash.slice(1) : '';
  var search = location.search ? location.search.slice(1) : '';
  var params = new URLSearchParams(hash || search);
  return params.get('highlight');
}

function initDefaultHighlight() {
  var target = getHighlightParam();
  if (target) highlightByName(target);
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initDefaultHighlight);
} else {
  initDefaultHighlight();
}
//]]>
</script>

{#- Plot area -#}
<g id="scatter" transform="translate({{ margin_left }}, {{ margin_top }})">

  {#- axis baselines -#}
  <line class="axis-line" x1="0" y1="{{ plot_h }}" x2="{{ plot_w }}" y2="{{ plot_h }}" />
  <line class="axis-line" x1="0" y1="0" x2="0" y2="{{ plot_h }}" />

  {#- ticks (X) -#}
  {%- for tick in xtick_data -%}
  <line class="tick-mark" x1="{{ tick.px }}" y1="{{ plot_h }}" x2="{{ tick.px }}" y2="{{ plot_h + 6 }}" />
  <text class="tick-label" x="{{ tick.px }}" y="{{ plot_h + 18 }}" text-anchor="middle">{{ tick.t }}</text>
  {%- endfor -%}

  {#- ticks (Y) -#}
  {%- for tick in ytick_data -%}
  <line class="tick-mark" x1="0" y1="{{ tick.py }}" x2="-6" y2="{{ tick.py }}" />
  <text class="tick-label" x="-8" y="{{ tick.py }}" text-anchor="middle" transform="rotate(-90, -8, {{ tick.py }})">{{ tick.t }}</text>
  {%- endfor -%}

  {#- guide lines -#}
  {%- for g in guide_lines -%}
  <line class="guide" x1="{{ g.x1 }}" y1="{{ g.y1 }}" x2="{{ g.x2 }}" y2="{{ g.y2 }}" stroke-width="{{ g.w }}" />
  {%- endfor -%}

  {#- markers -#}
  {%- for p in points -%}
  <g class="marker" transform="translate({{ p.sx }}, {{ p.sy }})" onmouseover="sT(event)" onmouseout="ht(event)">
    <circle r="{{ p.r }}" data-base-r="{{ p.r }}" class="dot" data-title='{{ p.tooltip | tojson }}' fill="{{ p.color }}" stroke="#000" stroke-width="{{ p.line_width }}" data-base-sw="{{ p.line_width }}" data-type="{{ p.type }}"></circle>
  </g>
  {%- endfor -%}
</g>

{#- Axis labels -#}
<text class="axis-label" text-anchor="middle" x="{{ margin_left + plot_w/2 }}" y="{{ margin_top + plot_h + 40 }}" data-tooltip='{{ xlabel_hover | tojson }}' onmouseover="sT(event)" onmouseout="ht(event)">{{ xlabel }}</text>
<text class="axis-label" text-anchor="middle" transform="translate(25, {{ margin_top + plot_h/2 }}) rotate(-90)" data-tooltip='{{ ylabel_hover | tojson }}' onmouseover="sT(event)" onmouseout="ht(event)">{{ ylabel }}</text>

<text class="title" text-anchor="end" dominant-baseline="hanging" x="{{ plot_w + 50 }}" y="{{ 60 }}">{{ title }}</text>

{#- Legend -#}
<g transform="translate({{ margin_left + plot_w + 12 }}, {{ margin_top }})">
  <defs>
    <linearGradient id="covGradV" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="rgb(180,0,0)" />
      <stop offset="100%" stop-color="rgb(255,255,255)" />
    </linearGradient>
  </defs>
  <text class="legend-title" text-anchor="middle" transform="translate(30, {{ plot_h/2 }}) rotate(-90)" data-tooltip='{{ legend_label_hover | tojson }}' onmouseover="sT(event)" onmouseout="ht(event)">{{ legend_label }}</text>
  <rect x="0" y="0" width="{{ legend_w }}" height="{{ plot_h }}" fill="url(#covGradV)" stroke="#ccc" stroke-width="0.5" />
  <text class="legend-label" x="16" y="10" text-anchor="start">>{{ '%.0f' % cmax }}</text>
  <text class="legend-label" x="16" y="{{ plot_h - 2 }}" text-anchor="start">{{ '%.0f' % cmin }}</text>
</g>

{#- Tooltip -#}
<g id="tooltip" class="tooltip-box" opacity="0">
  <rect id="tooltip-rect" class="tooltip-rect" />
  <g id="tooltip-text-group" />
</g>

</svg>
